# Documentation of development of PocketA 

## Step 1: Simple API

### Create a linode

Go to linode.com. Create or access account. Create a ubuntu linode, start with a shared cpu Nanode. Create and/or add ssh. 

### Excurse ssh

If you run a windows system, get the ubuntu subsystem from the windows store. Start the ubuntu subsystem. A terminal window opens and you have a linux distribution on your windows machine! On Linux or MacOS simply start a terminal.

Now create the key pair on the client machine (your computer). The key pair consists of a public and a private key. You can share the public key, but keep the private key secret. You can create the key pair with following command:

```
$ ssh-keygen
```

Just accept the file location with yes. The location will be the .ssh directory in your personal home directory /home/username.

Enter a passphrase to secure your ssh key-pair.
Now you can place the public key on your linode server. To copy the public key, change to the .ssh directory.

```
$ cd ~/.ssh
```

Now list the files in the .ssh directory with

```
$ ls
```

You should see see two files with names starting with id_
One of the files ends with the .pub file extension, e. g. id_ed25519.pub
This is your public key, that you can share. To copy it, write the following command:

```
cat id_ed25519.pub
```

Your key is now displayed in the terminal. Mark the text of the key and copy it with SHIFT-CTRL-c.
Now open linode.com and go to your dashboard. At the right of your linode you see three dots. Click on the dots and choose "Rebuild" to make changes to SSH. Under SSH Keys click the button "Add a SSH Key" and follow the instructions to add your public key to the SSH Keys of your Linode.

Now you shoul be able to ssh from your computer into your linode.

### Harden the linode server

#### Update and Upgrade

Visit your linode via ssh (for xxx.xxx.xxx.xxx use the ip address of your linode):

```
ssh root@xxx.xxx.xxx.xxx
```

Update and upgrade your linode: 

```
apt update && apt dist-upgrade -y
```

To initialize the updates, rebbot the linode server.

```
reboot
```

 After rebooting, ssh again into the server.

```
ssh root@xxx.xxx.xxx.xxx
```

It is important to keep our server updated on a regular basis. To make this a little bit easier, let us use a package to do the job automatically for us. 

```
sudo apt install unattended-upgrades
```

To use the package, write following command:

```
dpkg-reconfigure --priority=low unattended-upgrades
```

#### PermitRootLogin, AllowUsers and PasswordAuthenticaion

For the security of the application it it recommended to create a specific user for the server and do not allow root to make changes to the system. Add this with only ssh access without password authentification to avoid password brute force attacks.

It is time to create the new user 'pocketa' for the application:

```
adduser pocketa
```

Type in the New password for the new user pocketa and confirm the password. If you wish, fill out the next questions or simply press Enter to leave it blank. Confirm your input data with Yes. 

Now add the new user pocketa to the sudo group: 

```
usermod -aG sudo pocketa
```

The user pocketa has now sudo privileges. We want to make our server more secure and in that case, won't allow root to access the server any more. And we want to access our server only via ssh, not via password. To achieve this, we are going to change sshd-config. But first, let us prepare the change of the config-file.

First, change account to user pocketa via

```
su - pocketa
```

You should now see, that you are "pocketa@localhost" instead of "root@localhost".

Second, copy your ssh public key to the server. You need the ip-address of your linode. Inside the server, you are pocketa@localhost, but from outside the server, you are pocketa@xxx.xxx.xxx.xxx, with xxx.xxx.xxx.xxx as the ip-address of your linode. You need to logout from the server with CTRL-d. Now you should be back in your client machine. Now copy your public ssh key to the linode server via

```
ssh-copy-id pocketa@xxx.xxx.xxx.xxx
```

Try to login to the linode server without to input the password on the serverside. (If you have protected your ssh key on the client side, of course you have to input your password on client side.) Try to ssh into the linode server with

```
ssh pocketa@xxx.xxx.xxx.xxx
```

Granted access to the server without the input of a password on serverside? Great job! Now we can establish the access exclusivly via ssh and don't allow root-access. For this, open the config-file via

```
sudo vim /etc/ssh/sshd-config
``` 

Search for the line with "PermitRootLogin yes" and change it to "PermitRootLogin no".

Add in a new line "AllowUsers pocketa" to just allow user 'pocketa' access to the server.

Now search for the line with "PasswordAuthentication yes" and change it to "Password Authentication no".
Save the file and quit vim.

To make the changes work, restart the ssh daemon (sshd) with the command:

```
sudo systemctl restart sshd
```

Logout and try to access via 

```
ssh root@xxx.xxx.xxx.xxx
```

It should not be possible. Now try to access via

```
ssh pocketa@xxx.xxx.xxx.xxx
```

You should be able to access the server. If you have any problems entering the linode server, you can enter it via the lish console as root and make changes at the sshd-config. Just go over to linode.com and entervia lish-console.

If everything works as expected: Congratulations! You have now access to your application server from your client machine and with a more solid security layer.

### start postgres database

#### Check postgresql installation

Check if postgres is already installed with

```
psql --version
```

If postgresql is installed, you will get an output like

```
psql (PostgreSQL) 14.8 (Ubuntu 14.8-0ubuntu0.22.04.1)
```

Else you need to install, configure and start postgres.

#### How to install and use postgresql on Ubuntu/Debian linode

Update and upgrade the system.

```
sudo apt update && sudo apt upgrade -y
```

Install PostgreSQL and all dependencies, along with the postgresql-contrib module that provides additional functionality.

```
sudo apt-get install postgresql postgresql-contrib
```

Ensure PostgreSQL is running with systemctl.

```
sudo systemctl start postgresql.service
```

To automatically launch PostgreSQL upon system boot-up, register it with systemctl.

```
sudo systemctl enable postgresql.service
```

Output:
```
    postgresql.service - PostgreSQL RDBMS

    Loaded: loaded (/lib/systemd/system/postgresql.service; enabled; vendor preset: enabled)

    Active: active (exited) since Sun 2022-11-20 20:01:42 CET; 6min ago
```

#### Securing postgresql and accessing the postgresql-shell

Add a password for postgres. postgres is the user to enter the postgresql-shell.
```
    sudo passwd postgres
```
Confirm your user password for the sudo command.

Output:
```
    New password:
```
Enter the new password for user postgres.

Output:
```
    Retype new password:
```
Confirm password by reentering it.

You should get the output:
```
    passwd: password updated successfully
```
Switch over to the postgres account.
```
    su - postgres
```
Output:
```
    Password:
```
After entering the password for user postgres, the prompt changes to postgres@hostname:~$

You can check the version with
```
    psql -c "SELECT version();"
```
Exit with ":q"

Now try to access the postgresql-shell.
```
    psql postgres
```
Output:
```
    postgres@hostname:~$ psql postgres

    psql (14.5 (Ubuntu 14.5-0ubuntu0.22.04.1))

    Type "help" for help.

    postgres=#
```
#### Create database

You need to create a database to store your data from the application. It is not possible to create the database from the application! After creating the database itself, the application will create all neccessary tables for you. For creating the database you will need specific data:
1. Host

If you run the database on your own computer, then choose localhost for host, else use the ip_address of the server.
2. Port

The default port for psql is 5432.
3. Database

This is the name of the database. If you like you can choose 'hs_edv' or you name it the way you want.
4. User

To make the access to the database secure, you need a user as the owner of the database. Choose a name for the owner.
5. Password

To get access to the database as owner, verify yourself with a password.
Create the access-data as psql_db.ini and add it to the backend.datamodule directory

The application needs your access-data from this psql_db.ini file in the config_db.py. Make sure to create the file as follows

[postgresql]
host = 127.0.0.1
port = 5432
database = add_here_the_name_for_the_database
user = add_here_the_owner_name_of_the_database
password = add_here_your_password_for_the_database

Create the database

Change user to postgres:
```
    sudo su - postgres
```
After confirming password you should see user postgres:
```
    postgres@device:~$
```
Enter the psql-shell with
```
    psql
```
You can list all database with
```
    \l
```
Let's now create the database with the chosen parameters from the psql_db.ini. For the application in Germany, the encoding of the data into the ISO-8859-1 format is necessary. By default, the utf-8 format is set. However, utf-8 is not or only partially compatible with the requirements of the GKV Spitzenverband for the DTA. Encoding in the right format should therefore be ensured, as a subsequent change would corrupt the data.
```
    CREATE DATABASE add_here_the_name_for_the_database WITH OWNER add_here_the_owner_name_of_the_database TEMPLATE template0 ENCODING ISO88591 LOCALE 'de_DE.iso88591';
```
You should get an output like
```
    CREATE DATABASE
```
Check the new database in the list with
```
    \l
```
Add privileges to the owner
Check database data

At the moment database is running on localhost. Later it will be deployed on a server.

In case postgres is installed, running and database hs_edv is created, change user to postgres:
```
    sudo su - postgres
```
After confirming password you should see user postgres:
```
    postgres@device:~$
```
You can now open database hs_edv with:
```
    psql hs_edv
```
You are now root in hs_edv:
```
hs_edv=#
```
Get a list of tables with '/d'. Show schema of a table with '/d+ table_name'. Operate with SQL-commands.

Leave the database with strg+d. You can return back to user@device with strg+d.` 
